# 🚀 AstrBot 日调用限制插件 v2.3

<div align="center">

![Version](https://img.shields.io/badge/版本-v2.3-blue)
![AstrBot](https://img.shields.io/badge/AstrBot-3.5.1%2B-green)
![Python](https://img.shields.io/badge/Python-3.10%2B-yellow)
![License](https://img.shields.io/badge/License-MIT-orange)

**智能管理AI资源使用，防止滥用，提升用户体验**

</div>

## ✨ 特性亮点

- 🛡️ **智能限制** - 基于每日调用次数的智能限制机制
- ⏰ **时间段限制** - 支持按时间段设置不同的调用限制
- 👥 **多级权限** - 支持用户、群组、豁免用户三级权限管理
- 🤝 **群组共享** - 群组成员共享使用次数，提升群组协作体验
- 👤 **群组独立** - 群组内成员独立使用次数，支持个性化配置
- 📊 **实时监控** - 提供使用统计、排行榜和状态监控
- 📈 **使用记录** - 详细记录每次调用，支持历史查询和多维度分析
- 🔄 **灵活重置** - 支持用户、群组或全部使用记录的重置
- 🎯 **精确控制** - 为不同用户和群组设置个性化限制
- 💾 **Redis支持** - 基于Redis的高性能数据存储

## 📖 文档

### 🎯 核心功能

本插件专为AstrBot设计，用于智能管理群组成员对大模型API的调用频率。通过精确的每日限制机制，有效防止资源滥用，确保AI服务的稳定性和公平性。

### 🎪 功能概览

本插件提供以下核心功能模块：

- **🛡️ 智能限制系统** - 基于每日调用次数的智能限制机制
- **⏰ 时间段限制** - 支持按时间段设置不同的调用限制
- **👥 多级权限管理** - 支持用户、群组、豁免用户三级权限管理
- **🤝 群组协作模式** - 支持共享模式和独立模式两种群组使用方式
- **📊 实时监控分析** - 提供使用统计、排行榜和状态监控
- **📈 使用记录系统** - 详细记录每次调用，支持历史查询和多维度分析
- **🔄 灵活重置机制** - 支持用户、群组或全部使用记录的重置

#### 🤝 群组使用模式

**v2.0 新增功能**：群组成员共享使用次数！
**v2.2 新增功能**：群组内成员独立使用次数！

##### 共享模式（默认）
- **群组消息**：群组内所有成员共享同一个使用次数限制
- **个人消息**：私聊消息仍按个人独立计数
- **智能切换**：插件自动识别消息类型，无缝切换计数模式
- **统一管理**：管理员可以分别重置用户或群组的使用次数

##### 独立模式（新增）
- **群组消息**：群组内每个成员有独立的使用次数限制
- **个人消息**：私聊消息仍按个人独立计数
- **灵活配置**：管理员可以为特定群组设置独立模式
- **模式切换**：支持为不同群组设置不同的使用模式

这种设计既保证了群组协作的便利性，又保持了个人使用的独立性，同时提供了更灵活的使用模式选择。

#### 📊 使用记录功能

**v2.1 新增功能**：详细记录每次调用，支持历史查询和多维度分析！

- **自动记录**：每次LLM调用自动记录时间、用户、群组等信息
- **历史查询**：支持查询特定用户或全局的历史使用记录
- **多维度统计**：提供用户活跃度、群组使用情况等分析数据
- **智能过期**：记录自动设置过期时间，避免存储空间无限增长

#### 📈 多维度统计分析

**v2.1 新增功能**：深入分析使用模式，提供数据驱动的管理决策！

- **全局统计**：总调用次数、活跃用户数等宏观指标
- **用户分析**：用户平均使用次数、使用频次分布等
- **群组分析**：群组活跃度、平均使用情况等
- **使用分布**：低、中、高使用频次的用户分布统计

### 🔄 版本更新

**v2.3 主要更新：**
- ✅ **时间段限制功能** - 支持按时间段设置不同的调用限制
- ✅ **时间段优先级** - 时间段限制优先级最高，覆盖其他所有限制
- ✅ **时间段管理命令** - 新增/limit timeperiod系列命令管理时间段限制
- ✅ **智能时间检查** - 自动检测当前时间是否在时间段内
- ✅ **独立计数机制** - 时间段使用次数独立于每日限制

**v2.2 主要更新：**
- ✅ **群组独立模式** - 支持群组内成员独立使用次数功能
- ✅ **模式切换配置** - 支持为特定群组单独配置使用模式
- ✅ **模式管理命令** - 新增/limit setmode和/limit getmode命令
- ✅ **智能状态显示** - 根据群组模式显示正确的使用状态
- ✅ **配置结构优化** - 新增group_mode_settings配置字段

**v2.1 主要更新：**
- ✅ **使用记录功能** - 自动记录每次调用，支持历史查询
- ✅ **多维度统计分析** - 提供用户、群组、全局等多维度分析
- ✅ **历史查询命令** - 新增/limit history命令查询使用历史
- ✅ **数据分析命令** - 新增/limit analytics命令进行深度分析
- ✅ **智能过期机制** - 记录自动过期，避免存储空间无限增长

**v2.0 主要更新：**
- ✅ **群组共享机制** - 群组成员共享使用次数，提升协作体验
- ✅ **智能计数切换** - 自动识别消息类型，无缝切换个人/群组计数
- ✅ **增强重置功能** - 支持用户、群组或全部记录的重置
- ✅ **优化排行榜** - 同时显示个人和群组使用排行榜
- ✅ **改进状态显示** - 分别显示个人和群组使用状态
- ✅ **增强命令结构** - 优化命令提示和错误处理

## ⚙️ 安装

### 系统要求

- **AstrBot版本**: v3.5.1+
- **Python版本**: 3.10+
- **Redis服务器**: 必须配置
- **依赖包**: `redis >= 4.5.0`

### 安装步骤

1. **安装Redis依赖**
   ```bash
   pip install redis>=4.5.0
   ```

2. **配置Redis服务器**
   - 确保Redis服务正常运行
   - 记录Redis连接信息（主机、端口、密码等）

3. **安装插件**
   - 将插件文件放置到AstrBot插件目录
   - 重启AstrBot服务

## 🔧 配置

### 📋 配置结构

插件配置文件采用JSON格式，包含以下主要部分：

#### Redis配置
```json
"redis": {
    "host": "localhost",
    "port": 6379,
    "db": 0,
    "password": ""
}
```

#### 限制配置
```json
"limits": {
    "default_daily_limit": 20,
    "exempt_users": [],
    "group_limits": [],
    "user_limits": [],
    "group_mode_settings": [],
    "time_period_limits": []
}
```


### 📝 配置说明

#### 默认限制
- `default_daily_limit`: 所有用户的默认每日调用次数（默认：20次）

#### 豁免用户
- `exempt_users`: 不受限制的用户ID列表
- 优先级最高，豁免用户无调用次数限制

#### 群组限制
```json
{
    "group_id": "群组ID",
    "limit": 15
}
```

#### 用户限制
```json
{
    "user_id": "用户ID",
    "limit": 10
}
```

#### 群组模式配置
```json
{
    "group_id": "群组ID",
    "mode": "shared"
}
```

**模式说明：**
- `"shared"`：共享模式（默认）- 群组成员共享使用次数
- `"individual"`：独立模式 - 群组内每个成员有独立的使用次数

**配置优先级：**
- 如果群组没有配置模式，默认使用共享模式
- 可以为不同群组设置不同的使用模式

#### 时间段限制配置
```json
{
    "start_time": "09:00",
    "end_time": "18:00",
    "limit": 10,
    "enabled": true
}
```

**时间段说明：**
- `start_time`：时间段开始时间（HH:MM格式）
- `end_time`：时间段结束时间（HH:MM格式）
- `limit`：该时间段内的最大调用次数
- `enabled`：是否启用该时间段限制

**时间段规则：**
- 支持设置多个时间段限制
- 时间段可以重叠，但会按配置顺序检查
- 时间段限制只在指定时间范围内生效
- 时间段限制优先级最高，覆盖其他所有限制

### 🔄 优先级规则

用户调用限制按以下优先级生效：
1. ⏰ **时间段限制** - 在指定时间段内生效，优先级最高
2. 🏆 **豁免用户** - 完全不受限制
3. 👤 **用户特定限制** - 针对单个用户的设置
4. 👥 **群组特定限制** - 针对整个群组的设置
5. ⚙️ **默认限制** - 全局默认设置

**时间段限制说明：**
- 当当前时间处于某个时间段内时，该时间段的限制生效
- 时间段限制独立于每日限制，在时间段内单独计数
- 时间段结束后，使用次数自动清零，不影响每日限制

## 💡 使用

### 👤 用户命令

| 命令 | 功能 | 示例 |
|------|------|------|
| `/limit_status` | 查看个人使用情况 | `/limit_status` |
| `/限制帮助` | 显示所有可用命令 | `/限制帮助` |

### 👨‍💼 管理员命令

#### 🔧 基础管理
| 命令 | 功能 | 示例 |
|------|------|------|
| `/limit help` | 显示详细帮助 | `/limit help` |
| `/limit set <用户ID> <次数>` | 设置用户限制 | `/limit set 123456 50` |
| `/limit setgroup <次数>` | 设置群组限制 | `/limit setgroup 30` |
| `/limit setmode <shared\|individual>` | 设置群组使用模式 | `/limit setmode shared` |
| `/limit getmode` | 查看群组使用模式 | `/limit getmode` |

#### ⏰ 时间段限制管理
| 命令 | 功能 | 示例 |
|------|------|------|
| `/limit timeperiod list` | 列出时间段限制 | `/limit timeperiod list` |
| `/limit timeperiod add <开始时间> <结束时间> <次数>` | 添加时间段限制 | `/limit timeperiod add 09:00 18:00 10` |
| `/limit timeperiod remove <索引>` | 删除时间段限制 | `/limit timeperiod remove 1` |
| `/limit timeperiod enable <索引>` | 启用时间段限制 | `/limit timeperiod enable 1` |
| `/limit timeperiod disable <索引>` | 禁用时间段限制 | `/limit timeperiod disable 1` |

#### 🛡️ 豁免管理
| 命令 | 功能 | 示例 |
|------|------|------|
| `/limit exempt <用户ID>` | 添加豁免用户 | `/limit exempt 123456` |
| `/limit unexempt <用户ID>` | 移除豁免用户 | `/limit unexempt 123456` |

#### 📊 查询功能
| 命令 | 功能 | 示例 |
|------|------|------|
| `/limit list_user` | 列出用户限制 | `/limit list_user` |
| `/limit list_group` | 列出群组限制 | `/limit list_group` |
| `/limit stats` | 查看今日统计 | `/limit stats` |
| `/limit history [用户ID] [天数]` | 查询使用历史 | `/limit history 123456 7` |
| `/limit analytics [日期]` | 多维度分析 | `/limit analytics 2025-01-23` |
| `/limit top [数量]` | 显示排行榜 | `/limit top 5` |
| `/limit status` | 查看插件状态 | `/limit status` |

#### 🔄 重置功能
| 命令 | 功能 | 示例 |
|------|------|------|
| `/limit reset all` | 重置所有使用记录 | `/limit reset all` |
| `/limit reset <用户ID>` | 重置特定用户 | `/limit reset 123456` |
| `/limit reset group <群组ID>` | 重置特定群组 | `/limit reset group 789012` |

## 🔄 更新日志

### v2.3 (2025-10-18)
- ✅ **时间段限制功能** - 支持按时间段设置不同的调用限制
- ✅ **时间段优先级** - 时间段限制优先级最高，覆盖其他所有限制
- ✅ **时间段管理命令** - 新增/limit timeperiod系列命令管理时间段限制
- ✅ **智能时间检查** - 自动检测当前时间是否在时间段内
- ✅ **独立计数机制** - 时间段使用次数独立于每日限制
- ✅ **配置结构优化** - 新增time_period_limits配置字段

### v2.2 (2025-10-17)
- ✅ **群组独立模式** - 支持群组内成员独立使用次数功能
- ✅ **模式切换配置** - 支持为特定群组单独配置使用模式
- ✅ **模式管理命令** - 新增/limit setmode和/limit getmode命令
- ✅ **智能状态显示** - 根据群组模式显示正确的使用状态
- ✅ **配置结构优化** - 新增group_mode_settings配置字段

### v2.1 (2025-10-17)
- ✅ **使用记录功能** - 自动记录每次调用，支持历史查询
- ✅ **多维度统计分析** - 提供用户、群组、全局等多维度分析
- ✅ **历史查询命令** - 新增/limit history命令查询使用历史
- ✅ **数据分析命令** - 新增/limit analytics命令进行深度分析
- ✅ **智能过期机制** - 记录自动过期，避免存储空间无限增长

### v2.0 (2025-10-16)
- ✅ **群组共享机制** - 群组成员共享使用次数，提升协作体验
- ✅ **智能计数切换** - 自动识别消息类型，无缝切换个人/群组计数
- ✅ **增强重置功能** - 支持用户、群组或全部记录的重置
- ✅ **优化排行榜** - 同时显示个人和群组使用排行榜
- ✅ **改进状态显示** - 分别显示个人和群组使用状态
- ✅ **增强命令结构** - 优化命令提示和错误处理

### v1.0.1
- ✅ 初始版本发布
- ✅ 基础限制功能实现
- ✅ Redis数据存储支持
- ✅ 多级权限管理

## 📞 技术支持

### 🐛 问题反馈
如遇到任何问题，请通过以下方式联系：
- 📧 Telegram: [@TamakiSakura520](https://t.me/TamakiSakura520)
- 💬 Issues: [GitHub Issues](https://github.com/left666/astrbot_plugin_daily_limit/issues)


### 🤝 贡献指南

我们欢迎社区贡献！如果您想为这个项目做出贡献，请遵循以下指南：

#### 🚀 如何贡献
1. **Fork 仓库** - 首先 fork 这个仓库到您的账户
2. **创建分支** - 为您的功能或修复创建一个新的分支
3. **提交更改** - 提交清晰的提交信息
4. **推送分支** - 将您的更改推送到您的 fork
5. **创建 Pull Request** - 提交 Pull Request 并描述您的更改

#### 📋 贡献规范
- 确保代码符合项目的编码风格
- 添加适当的测试用例
- 更新相关文档
- 确保所有测试通过

#### 🐛 报告问题
如果您发现任何问题，请通过 GitHub Issues 报告，并提供：
- 详细的问题描述
- 复现步骤
- 期望的行为
- 实际的行为
- 相关的日志或截图

## 📄 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。


<div align="center">

**🌟 如果这个插件对你有帮助，请给个Star支持一下！**

[![Star](https://img.shields.io/github/stars/left666/astrbot_plugin_daily_limit?style=social)](https://github.com/left666/astrbot_plugin_daily_limit)

</div>
