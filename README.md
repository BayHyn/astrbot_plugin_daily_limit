# 🚀 AstrBot 日调用限制插件 v2.2

<div align="center">

![Version](https://img.shields.io/badge/版本-v2.2-blue)
![AstrBot](https://img.shields.io/badge/AstrBot-3.5.1%2B-green)
![Python](https://img.shields.io/badge/Python-3.10%2B-yellow)
![License](https://img.shields.io/badge/License-MIT-orange)

**智能管理AI资源使用，防止滥用，提升用户体验**

</div>

## ✨ 特性亮点

- 🛡️ **智能限制** - 基于每日调用次数的智能限制机制
- 👥 **多级权限** - 支持用户、群组、豁免用户三级权限管理
- 🤝 **群组共享** - 群组成员共享使用次数，提升群组协作体验
- 👤 **群组独立** - 群组内成员独立使用次数，支持个性化配置
- 📊 **实时监控** - 提供使用统计、排行榜和状态监控
- 📈 **使用记录** - 详细记录每次调用，支持历史查询和多维度分析
- 🔄 **灵活重置** - 支持用户、群组或全部使用记录的重置
- 🎯 **精确控制** - 为不同用户和群组设置个性化限制
- 💾 **Redis支持** - 基于Redis的高性能数据存储

## 📖 文档

### 🎯 核心功能

本插件专为AstrBot设计，用于智能管理群组成员对大模型API的调用频率。通过精确的每日限制机制，有效防止资源滥用，确保AI服务的稳定性和公平性。

#### 🤝 群组使用模式

**v2.0 新增功能**：群组成员共享使用次数！
**v2.2 新增功能**：群组内成员独立使用次数！

##### 共享模式（默认）
- **群组消息**：群组内所有成员共享同一个使用次数限制
- **个人消息**：私聊消息仍按个人独立计数
- **智能切换**：插件自动识别消息类型，无缝切换计数模式
- **统一管理**：管理员可以分别重置用户或群组的使用次数

##### 独立模式（新增）
- **群组消息**：群组内每个成员有独立的使用次数限制
- **个人消息**：私聊消息仍按个人独立计数
- **灵活配置**：管理员可以为特定群组设置独立模式
- **模式切换**：支持为不同群组设置不同的使用模式

这种设计既保证了群组协作的便利性，又保持了个人使用的独立性，同时提供了更灵活的使用模式选择。

#### 📊 使用记录功能

**v2.1 新增功能**：详细记录每次调用，支持历史查询和多维度分析！

- **自动记录**：每次LLM调用自动记录时间、用户、群组等信息
- **历史查询**：支持查询特定用户或全局的历史使用记录
- **多维度统计**：提供用户活跃度、群组使用情况等分析数据
- **智能过期**：记录自动设置过期时间，避免存储空间无限增长

#### 📈 多维度统计分析

**v2.1 新增功能**：深入分析使用模式，提供数据驱动的管理决策！

- **全局统计**：总调用次数、活跃用户数等宏观指标
- **用户分析**：用户平均使用次数、使用频次分布等
- **群组分析**：群组活跃度、平均使用情况等
- **使用分布**：低、中、高使用频次的用户分布统计

### 🔄 版本更新

**v2.2 主要更新：**
- ✅ **群组独立模式** - 支持群组内成员独立使用次数功能
- ✅ **模式切换配置** - 支持为特定群组单独配置使用模式
- ✅ **模式管理命令** - 新增/limit setmode和/limit getmode命令
- ✅ **智能状态显示** - 根据群组模式显示正确的使用状态
- ✅ **配置结构优化** - 新增group_mode_settings配置字段

**v2.1 主要更新：**
- ✅ **使用记录功能** - 自动记录每次调用，支持历史查询
- ✅ **多维度统计分析** - 提供用户、群组、全局等多维度分析
- ✅ **历史查询命令** - 新增/limit history命令查询使用历史
- ✅ **数据分析命令** - 新增/limit analytics命令进行深度分析
- ✅ **智能过期机制** - 记录自动过期，避免存储空间无限增长

**v2.0 主要更新：**
- ✅ **群组共享机制** - 群组成员共享使用次数，提升协作体验
- ✅ **智能计数切换** - 自动识别消息类型，无缝切换个人/群组计数
- ✅ **增强重置功能** - 支持用户、群组或全部记录的重置
- ✅ **优化排行榜** - 同时显示个人和群组使用排行榜
- ✅ **改进状态显示** - 分别显示个人和群组使用状态
- ✅ **增强命令结构** - 优化命令提示和错误处理

## ⚙️ 安装

### 系统要求

- **AstrBot版本**: v3.5.1+
- **Python版本**: 3.10+
- **Redis服务器**: 必须配置
- **依赖包**: `redis >= 4.5.0`

### 安装步骤

1. **安装Redis依赖**
   ```bash
   pip install redis>=4.5.0
   ```

2. **配置Redis服务器**
   - 确保Redis服务正常运行
   - 记录Redis连接信息（主机、端口、密码等）

3. **安装插件**
   - 将插件文件放置到AstrBot插件目录
   - 重启AstrBot服务

## 🔧 配置

### 📋 配置结构

插件配置文件采用JSON格式，包含以下主要部分：

#### Redis配置
```json
"redis": {
    "host": "localhost",
    "port": 6379,
    "db": 0,
    "password": ""
}
```

#### 限制配置
```json
"limits": {
    "default_daily_limit": 20,
    "exempt_users": [],
    "group_limits": [],
    "user_limits": [],
    "group_mode_settings": []
}
```


### 📝 配置说明

#### 默认限制
- `default_daily_limit`: 所有用户的默认每日调用次数（默认：20次）

#### 豁免用户
- `exempt_users`: 不受限制的用户ID列表
- 优先级最高，豁免用户无调用次数限制

#### 群组限制
```json
{
    "group_id": "群组ID",
    "limit": 15
}
```

#### 用户限制
```json
{
    "user_id": "用户ID",
    "limit": 10
}
```

#### 群组模式配置
```json
{
    "group_id": "群组ID",
    "mode": "shared"
}
```

**模式说明：**
- `"shared"`：共享模式（默认）- 群组成员共享使用次数
- `"individual"`：独立模式 - 群组内每个成员有独立的使用次数

**配置优先级：**
- 如果群组没有配置模式，默认使用共享模式
- 可以为不同群组设置不同的使用模式

### 🔄 优先级规则

用户调用限制按以下优先级生效：
1. 🏆 **豁免用户** - 完全不受限制
2. 👤 **用户特定限制** - 针对单个用户的设置
3. 👥 **群组特定限制** - 针对整个群组的设置
4. ⚙️ **默认限制** - 全局默认设置

## 💡 使用

### 👤 用户命令

| 命令 | 功能 | 示例 |
|------|------|------|
| `/limit_status` | 查看个人使用情况 | `/limit_status` |
| `/限制帮助` | 显示所有可用命令 | `/限制帮助` |

### 👨‍💼 管理员命令

#### 🔧 基础管理
| 命令 | 功能 | 示例 |
|------|------|------|
| `/limit help` | 显示详细帮助 | `/limit help` |
| `/limit set <用户ID> <次数>` | 设置用户限制 | `/limit set 123456 50` |
| `/limit setgroup <次数>` | 设置群组限制 | `/limit setgroup 30` |
| `/limit setmode <shared\|individual>` | 设置群组使用模式 | `/limit setmode shared` |
| `/limit getmode` | 查看群组使用模式 | `/limit getmode` |

#### 🛡️ 豁免管理
| 命令 | 功能 | 示例 |
|------|------|------|
| `/limit exempt <用户ID>` | 添加豁免用户 | `/limit exempt 123456` |
| `/limit unexempt <用户ID>` | 移除豁免用户 | `/limit unexempt 123456` |

#### 📊 查询功能
| 命令 | 功能 | 示例 |
|------|------|------|
| `/limit list_user` | 列出用户限制 | `/limit list_user` |
| `/limit list_group` | 列出群组限制 | `/limit list_group` |
| `/limit stats` | 查看今日统计 | `/limit stats` |
| `/limit history [用户ID] [天数]` | 查询使用历史 | `/limit history 123456 7` |
| `/limit analytics [日期]` | 多维度分析 | `/limit analytics 2025-01-23` |
| `/limit top [数量]` | 显示排行榜 | `/limit top 5` |
| `/limit status` | 查看插件状态 | `/limit status` |

#### 🔄 重置功能
| 命令 | 功能 | 示例 |
|------|------|------|
| `/limit reset all` | 重置所有使用记录 | `/limit reset all` |
| `/limit reset <用户ID>` | 重置特定用户 | `/limit reset 123456` |
| `/limit reset group <群组ID>` | 重置特定群组 | `/limit reset group 789012` |

## 🔄 更新日志

### v2.2 (2025-10-17)
- ✅ **群组独立模式** - 支持群组内成员独立使用次数功能
- ✅ **模式切换配置** - 支持为特定群组单独配置使用模式
- ✅ **模式管理命令** - 新增/limit setmode和/limit getmode命令
- ✅ **智能状态显示** - 根据群组模式显示正确的使用状态
- ✅ **配置结构优化** - 新增group_mode_settings配置字段

### v2.1 (2025-10-17)
- ✅ **使用记录功能** - 自动记录每次调用，支持历史查询
- ✅ **多维度统计分析** - 提供用户、群组、全局等多维度分析
- ✅ **历史查询命令** - 新增/limit history命令查询使用历史
- ✅ **数据分析命令** - 新增/limit analytics命令进行深度分析
- ✅ **智能过期机制** - 记录自动过期，避免存储空间无限增长

### v2.0 (2025-10-16)
- ✅ **群组共享机制** - 群组成员共享使用次数，提升协作体验
- ✅ **智能计数切换** - 自动识别消息类型，无缝切换个人/群组计数
- ✅ **增强重置功能** - 支持用户、群组或全部记录的重置
- ✅ **优化排行榜** - 同时显示个人和群组使用排行榜
- ✅ **改进状态显示** - 分别显示个人和群组使用状态
- ✅ **增强命令结构** - 优化命令提示和错误处理

### v1.0.1 (2024-04-02)
- ✅ 初始版本发布
- ✅ 基础限制功能实现
- ✅ Redis数据存储支持
- ✅ 多级权限管理

## 📞 技术支持

### 🐛 问题反馈
如遇到任何问题，请通过以下方式联系：
- 📧 Telegram: [@TamakiSakura520](https://t.me/TamakiSakura520)
- 💬 Issues: [GitHub Issues](https://github.com/Sakura520222/astrbot_plugin_daily_limit/issues)


### 🤝 贡献指南
欢迎提交Pull Request来改进这个项目！

## 📄 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 🙏 致谢

感谢原作者的贡献：
- 👨‍💻 **原作者**: left666
- 🔗 **原仓库**: [https://github.com/left666/astrbot_plugin_daily_limit](https://github.com/left666/astrbot_plugin_daily_limit)

---

<div align="center">

**🌟 如果这个插件对你有帮助，请给个Star支持一下！**

[![Star](https://img.shields.io/github/stars/Sakura520222/astrbot_plugin_daily_limit?style=social)](https://github.com/Sakura520222/astrbot_plugin_daily_limit)

</div>
